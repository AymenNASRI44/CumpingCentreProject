pipeline {
    agent any

    environment {
        COMPOSE_FILE = 'docker-compose.yaml'
    }

    stages {
        stage('ğŸ“¥ RÃ©cupÃ©ration du code') {
            steps {
                checkout scm
            }
        }

        stage('ğŸ³ Build des conteneurs') {
            steps {
                sh 'docker-compose build'
            }
        }

        stage('ğŸš€ Lancement des services') {
            steps {
                sh 'docker-compose up -d'
            }
        }

        stage('ğŸ§ª Installation des dÃ©pendances') {
            steps {
                sh 'docker-compose exec -T app composer install'
            }
        }

        stage('ğŸ” VÃ©rification de la base de donnÃ©es') {
            steps {
                sh 'docker-compose exec -T app php bin/console doctrine:schema:validate'
            }
        }

        stage('ğŸ§ª Lancement des tests') {
            steps {
                sh 'docker-compose exec -T app ./vendor/bin/phpunit'
            }
        }

        stage('ğŸ§¹ Nettoyage (arrÃªt des conteneurs)') {
            steps {
                sh 'docker-compose down'
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline exÃ©cutÃ©e avec succÃ¨s !'
        }
        failure {
            echo 'âŒ Ã‰chec de la pipeline. VÃ©rifiez les logs.'
            sh 'docker-compose down' // Assure que tout s'arrÃªte mÃªme si une Ã©tape Ã©choue
        }
    }
}
